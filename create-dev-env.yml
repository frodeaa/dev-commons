Description: |
  Create an EC2 development instance with vim, git, tmux, mosh and
  docker installed.

Parameters:

  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: |
      Name of an existing EC2 KeyPair to enable SSH access to the
      instance

  CidrIp:
    Type: String
    Description: |
      Specify the IPv4 CIDR range for ingress (SSH/Mosh) allowed by
      the security group added to the EC2 instance
    Default: "0.0.0.0/0"
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(3[0-2]|[1-2][0-9]|[0-9]))$

  CidrIpv6:
    Type: String
    Description: |
      Specify the IPv6 CIDR range for ingress (SSH/Mosh) allowed by
      the security group added to the EC2 instance
    Default: "::/0"

Mappings:

  # These are the latest Ubuntu Server 18.04 LTS (HVM) as of 2018-09

  AWSRegionToAMI:
    eu-west-1:
      AMI: ami-00035f41c82244dab
    eu-central-1:
      AMI: ami-0bdf93799014acdc4

Resources:

  SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Enable SSH/Mosh access
      SecurityGroupIngress:
        - Description: SSH
          IpProtocol: TCP
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref CidrIp
        - Description: Mosh
          IpProtocol: UDP
          FromPort: 60000
          ToPort: 61000
          CidrIp: !Ref CidrIp
        - Description: SSH
          IpProtocol: TCP
          FromPort: 22
          ToPort: 22
          CidrIpv6: !Ref CidrIpv6
        - Description: Mosh
          IpProtocol: UDP
          FromPort: 60000
          ToPort: 61000
          CidrIpv6: !Ref CidrIpv6
